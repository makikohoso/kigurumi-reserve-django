<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>予約システム</title>
    
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Tailwind CSS の CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Flatpickr CSS and JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
    <script>
      document.addEventListener("dblclick", function(e){ e.preventDefault();}, { passive: false });
    </script>
    <style>
      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      /* プルダウン選択メニューのスタイル調整 */
      select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        padding-right: 2.5rem;
      }

      /* ブラウザ固有のスタイル調整 */
      select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        padding-right: 2.5rem;
      }

      /* Firefox用の追加調整 */
      @supports (-moz-appearance: none) {
        select {
          text-indent: 0.01px;
          text-overflow: '';
        }
      }

      /* Safari用の追加調整 */
      @supports (-webkit-appearance: none) {
        select {
          border-radius: 5px;
        }
      }
      
      /* カスタムスタイル */
      .day-cell {
        position: relative;
      }
      .status-marker {
        text-align: center;
        border-radius: 50%;
      }
    </style>
</head>
<body class="bg-zinc-100 text-zinc-600">
    <!-- アプリ本体 -->
    <div id="app" class="container mx-auto px-4 py-8 max-w-5xl">
        <div class="flex justify-between items-center mb-4 md:mb-8">
            <h1 class="text-xl md:text-3xl sm:text-2xl font-bold">予約システム</h1>
            <div class="flex gap-2">
                <a href="/reservations/" class="inline-flex items-center gap-1 px-3 py-2 text-sm font-medium text-white bg-cyan-500 hover:bg-cyan-600 rounded-lg transition-colors whitespace-nowrap shadow-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                    </svg>
                    予約状況確認
                </a>
                <a href="/admin/" class="text-sm text-cyan-600 hover:underline px-3 py-2">管理画面</a>
            </div>
        </div>
        
        <!-- カレンダー部分 -->
        <div class="bg-white rounded-lg shadow-[0_0_5px_0_rgba(0,0,0,0.05)] py-6 px-4 md:py-6 md:px-6 mb-6">
            
            <!-- 物品選択プルダウン -->
            <div class="flex flex-col justify-between md:flex-row items-center sm:items-left max-w-full overflow-hidden mb-6 pb-6 border-b">
                <label for="calendar-item" class="font-semibold mb-3 md:mb-0 md:mr-2 text-base sm:text-base">レンタル物品と日付を選択してください</label>
                <select id="calendar-item" class="w-full md:w-[425px] border rounded p-2 sm:p-3 text-sm sm:text-sm md:text-base focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-inset bg-white h-12 md:h-auto">
                    <option value="">物品を選択してください</option>
                    {% for item in items %}
                        <option value="{{ item.id }}">{{ item.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- カレンダー表示エリア -->
            <div id="calendar-container" class="hidden">
                <!-- 月表示とナビゲーションボタン -->
                <div class="flex flex-col justify-between items-center mb-3">
                    <div class="flex w-full justify-between items-center mb-2 sm:mb-3">
                        <button id="prev-month" class="bg-cyan-500 hover:bg-cyan-600 text-white py-4 px-4 sm:py-3 sm:px-4 md:py-2 md:px-4 text-xs sm:text-sm md:text-base rounded mr-2 sm:mr-3 md:mr-4 transition">前月</button>
                        <h3 id="current-month" class="text-base sm:text-lg md:text-xl font-semibold">2025年8月</h3>
                        <button id="next-month" class="bg-cyan-500 hover:bg-cyan-600 text-white py-4 px-4 sm:py-3 sm:px-4 md:py-2 md:px-4 text-xs sm:text-sm md:text-base rounded ml-2 sm:ml-3 md:ml-4 transition">翌月</button>
                    </div>
                </div>
                
                <!-- 凡例 -->
                <div class="flex justify-center gap-2 sm:gap-3 md:gap-4 mb-3 sm:mb-4 md:mb-5 flex-wrap">
                    <div class="flex items-center">
                        <div class="mr-1 sm:mr-2 text-cyan-600 text-sm sm:text-base">◯</div>
                        <span class="text-xs sm:text-sm md:text-base">予約可能</span>
                    </div>
                    <div class="flex items-center">
                        <div class="mr-1 sm:mr-2 text-red-600 text-sm sm:text-base">✕</div>
                        <span class="text-xs sm:text-sm md:text-base">予約不可</span>
                    </div>
                </div>
                
                <div id="calendar-content">
                    <!-- カレンダーがここに動的に表示される -->
                </div>
                
                <p class="text-sm text-gray-600 text-center mt-4">※ ◯をクリックすると下のフォームに自動入力されます</p>
            </div>
            
            <!-- 選択なしの場合のメッセージ -->
            <div id="no-selection-message" class="text-center py-8 text-gray-500">
                上記プルダウンから物品を選択するとカレンダーが表示されます
            </div>
        </div>
        
        <!-- 予約フォーム部分 -->
        <div id="reservation-form-section" class="bg-white rounded-lg shadow-[0_0_5px_0_rgba(0,0,0,0.05)] py-6 px-4 md:py-6 md:px-6">
            <h2 class="text-xl sm:text-2xl font-bold text-center text-cyan-500 mb-4 sm:mb-5 md:mb-6">予約フォーム</h2>
            {% if error %}
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                    {{ error }}
                </div>
            {% endif %}
            <form method="post" class="space-y-5 sm:space-y-6">
                {% csrf_token %}
                <div>
                    <label for="item" class="block font-semibold mb-2 text-sm md:text-base">レンタル物品 *</label>
                    <select id="item" name="item" required class="w-full p-2 sm:p-3 text-sm md:text-base border rounded focus:outline-none focus:ring-2 focus:ring-cyan-500 bg-white h-12 md:h-auto">
                        <option value="">選択してください</option>
                        {% for item in items %}
                            <option value="{{ item.id }}">{{ item.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="date" class="block font-semibold mb-2 text-sm md:text-base">予約日 *</label>
                    <input type="date" id="date" name="date" required class="w-full p-2 sm:p-3 text-sm md:text-base border rounded focus:outline-none focus:ring-2 focus:ring-cyan-500 bg-white h-12 md:h-auto">
                </div>
                
                <div>
                    <label for="name" class="block font-semibold mb-2 text-sm md:text-base">名前 *</label>
                    <input type="text" id="name" name="name" required class="w-full p-2 sm:p-3 text-sm md:text-base border rounded focus:outline-none focus:ring-2 focus:ring-cyan-500 h-12 md:h-auto" placeholder="予約者名">
                </div>
                
                <button type="submit" class="block w-full md:max-w-xs mx-auto bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-4 sm:py-3 md:py-4 px-3 sm:px-4 md:px-10 text-sm md:text-base rounded transition mt-4 sm:mt-5 md:mt-6">予約する</button>
                
                <div id="message" class="mt-4 text-center hidden text-sm md:text-base"></div>
            </form>
        </div>
    </div>

    <script>
        // flatpickrの初期化
        let datePicker = null;
        
        function initializeDatePicker(disabledDates = []) {
            if (datePicker) {
                datePicker.destroy();
            }
            
            const today = new Date();
            const oneYearLater = new Date();
            oneYearLater.setFullYear(today.getFullYear() + 1);
            
            datePicker = flatpickr("#date", {
                locale: "ja",
                dateFormat: "Y-m-d",
                minDate: today,
                maxDate: oneYearLater,
                defaultDate: today,
                disable: disabledDates,
                onChange: function(selectedDates, dateStr, instance) {
                    // 日付が選択されたときの処理
                }
            });
        }
        
        // 初期化（物品未選択時は空の無効日付配列）
        initializeDatePicker();
        
        // CSRF トークンを取得する関数
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // カレンダー物品選択の変更イベント
        document.getElementById('calendar-item').addEventListener('change', function() {
            const itemId = this.value;
            const calendarContainer = document.getElementById('calendar-container');
            const noSelectionMessage = document.getElementById('no-selection-message');
            const calendarContent = document.getElementById('calendar-content');
            
            if (itemId === '') {
                // 選択なしの場合
                calendarContainer.classList.add('hidden');
                noSelectionMessage.classList.remove('hidden');
            } else {
                // 物品が選択された場合
                noSelectionMessage.classList.add('hidden');
                calendarContainer.classList.remove('hidden');
                loadCalendar(itemId);
            }
        });
        
        // フォームの物品選択変更イベント（flatpickr更新用）
        document.getElementById('item').addEventListener('change', function() {
            const itemId = this.value;
            
            if (itemId === '') {
                // 物品未選択の場合は無効日付なし
                initializeDatePicker([]);
            } else {
                // 選択された物品の無効日付を取得してflatpickrを更新
                updateDatePickerDisabledDates(itemId);
            }
        });
        
        // 予約不可日付を取得してflatpickrを更新する関数
        function updateDatePickerDisabledDates(itemId) {
            return fetch(`/disabled-dates/${itemId}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 無効日付でflatpickrを再初期化
                    initializeDatePicker(data.disabled_dates);
                    return data.disabled_dates;
                } else {
                    console.error('Failed to get disabled dates:', data.error);
                    // エラーの場合は無効日付なしで初期化
                    initializeDatePicker([]);
                    return [];
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // エラーの場合は無効日付なしで初期化
                initializeDatePicker([]);
                return [];
            });
        }
        
        // 現在の表示月を管理
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        let currentItemId = null;
        
        // カレンダーデータを読み込む関数
        function loadCalendar(itemId, year = null, month = null) {
            const calendarContent = document.getElementById('calendar-content');
            calendarContent.innerHTML = '<div class="text-center py-4">読み込み中...</div>';
            
            // 現在のアイテムIDと月を保存
            currentItemId = itemId;
            if (year !== null) currentYear = year;
            if (month !== null) currentMonth = month;
            
            fetch(`/calendar-data/${itemId}/?year=${currentYear}&month=${currentMonth}`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayCalendar(data.calendar_data);
                } else {
                    calendarContent.innerHTML = '<div class="text-center py-4 text-red-500">カレンダーの読み込みに失敗しました</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                calendarContent.innerHTML = '<div class="text-center py-4 text-red-500">エラーが発生しました</div>';
            });
        }
        
        // カレンダーを表示する関数
        function displayCalendar(calendarData) {
            const calendarContent = document.getElementById('calendar-content');
            
            // 月表示を更新
            document.getElementById('current-month').textContent = calendarData.month_name;
            
            let html = '<div class="overflow-x-auto">';
            html += '<table class="w-full border-collapse">';
            
            // ヘッダー（曜日）- _publicスタイルに合わせる
            html += '<thead>';
            html += '<tr class="border-r">';
            html += '<th class="border-l border-t border-b p-1 sm:p-2 bg-gray-50 font-normal text-red-700 text-xs sm:text-sm md:text-base">日</th>';
            html += '<th class="border-l border-t border-b p-1 sm:p-2 bg-gray-50 font-normal text-xs sm:text-sm md:text-base">月</th>';
            html += '<th class="border-l border-t border-b p-1 sm:p-2 bg-gray-50 font-normal text-xs sm:text-sm md:text-base">火</th>';
            html += '<th class="border-l border-t border-b p-1 sm:p-2 bg-gray-50 font-normal text-xs sm:text-sm md:text-base">水</th>';
            html += '<th class="border-l border-t border-b p-1 sm:p-2 bg-gray-50 font-normal text-xs sm:text-sm md:text-base">木</th>';
            html += '<th class="border-l border-t border-b p-1 sm:p-2 bg-gray-50 font-normal text-xs sm:text-sm md:text-base">金</th>';
            html += '<th class="border-l border-t border-b p-1 sm:p-2 bg-gray-50 font-normal text-cyan-700 text-xs sm:text-sm md:text-base">土</th>';
            html += '</tr>';
            html += '</thead>';
            
            // カレンダーボディ（実際のデータ）- _publicスタイルに合わせる
            html += '<tbody id="calendar-body" class="border-r border-b border-l">';
            calendarData.weeks.forEach(week => {
                html += '<tr>';
                week.forEach((day, index) => {
                    // 当月以外または過去の日付は薄いグレー
                    const isInactive = !day.is_current_month || day.is_past_date;
                    const statusColor = isInactive ? 'text-gray-300' : 
                                       day.is_available ? 'text-cyan-600' : 'text-red-600';
                    const hoverClass = day.is_available && !isInactive ? 'hover:bg-cyan-50' : '';
                    const clickable = day.is_available && !isInactive ? `onclick="selectDate('${day.date}')"` : '';
                    const cursor = day.is_available && !isInactive ? 'cursor-pointer' : 'cursor-not-allowed';
                    
                    // 日付の色（日曜日：赤、土曜日：青、その他：グレー、ただし当月以外は薄く）
                    let dayColor = 'text-gray-700';
                    if (isInactive) {
                        dayColor = 'text-gray-300';
                    } else if (index === 0) {
                        dayColor = 'text-red-700';
                    } else if (index === 6) {
                        dayColor = 'text-cyan-700';
                    }
                    
                    html += `<td class="day-cell border-l border-t p-1 sm:p-2 text-center min-h-[60px] sm:min-h-[70px] md:min-h-[80px] ${hoverClass}">
                        <div class="text-xs sm:text-sm md:text-base mb-1 ${dayColor}">${day.day}</div>
                        <div class="status-marker ${cursor} text-sm sm:text-base md:text-lg ${statusColor} transition-colors" ${clickable}>
                            ${day.status_text}
                        </div>
                    </td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            
            calendarContent.innerHTML = html;
            
            // 前月・翌月ボタンのイベントリスナーを設定
            setupMonthNavigation();
        }
        
        // 前月・翌月ナビゲーションの設定
        function setupMonthNavigation() {
            document.getElementById('prev-month').onclick = function() {
                if (currentItemId) {
                    let prevMonth = currentMonth - 1;
                    let prevYear = currentYear;
                    if (prevMonth < 1) {
                        prevMonth = 12;
                        prevYear--;
                    }
                    loadCalendar(currentItemId, prevYear, prevMonth);
                }
            };
            
            document.getElementById('next-month').onclick = function() {
                if (currentItemId) {
                    let nextMonth = currentMonth + 1;
                    let nextYear = currentYear;
                    if (nextMonth > 12) {
                        nextMonth = 1;
                        nextYear++;
                    }
                    loadCalendar(currentItemId, nextYear, nextMonth);
                }
            };
        }
        
        // カレンダーの日付選択関数
        function selectDate(dateStr) {
            const itemSelect = document.getElementById('calendar-item');
            const itemId = itemSelect.value;
            const itemName = itemSelect.options[itemSelect.selectedIndex].text;
            
            // フォームの物品選択を更新
            document.getElementById('item').value = itemId;
            
            // 物品選択が変更されたので、flatpickrの無効日付を更新してから日付を設定
            updateDatePickerDisabledDates(itemId).then(() => {
                // flatpickrで日付を設定
                if (datePicker) {
                    datePicker.setDate(dateStr, false); // triggerChangeをfalseにして無限ループを防ぐ
                } else {
                    document.getElementById('date').value = dateStr;
                }
            });
            
            // 選択された日付をハイライト表示
            highlightSelectedDate(dateStr);
            
            // 予約フォームにスムーズスクロール
            const formSection = document.getElementById('reservation-form-section');
            if (formSection) {
                formSection.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }
            
            console.log(`選択: ${dateStr}, 物品: ${itemName}`);
        }
        
        // フォーム送信前のバリデーション
        document.querySelector('form').addEventListener('submit', function(e) {
            const selectedDate = document.getElementById('date').value;
            const selectedItemId = document.getElementById('item').value;
            
            if (selectedDate && selectedItemId) {
                // 選択された日付が予約可能かチェック
                fetch(`/check-availability/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({
                        date: selectedDate,
                        item_id: selectedItemId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.available) {
                        e.preventDefault();
                        alert('申し訳ございませんが、選択された日付は既に予約済みまたは利用不可です。他の日付をお選びください。');
                        return false;
                    }
                })
                .catch(error => {
                    console.error('Availability check error:', error);
                });
            }
        });
        
        // 選択した日付をハイライト表示する関数
        function highlightSelectedDate(selectedDate) {
            // 以前のハイライトを削除
            const previousHighlighted = document.querySelectorAll('.selected-date');
            previousHighlighted.forEach(element => {
                element.classList.remove('selected-date', 'bg-yellow-200', 'border-2', 'border-yellow-400');
            });
            
            // 新しい日付をハイライト
            const allCells = document.querySelectorAll('.day-cell');
            allCells.forEach(cell => {
                const statusMarker = cell.querySelector('.status-marker');
                if (statusMarker && statusMarker.getAttribute('onclick')) {
                    const onclickValue = statusMarker.getAttribute('onclick');
                    if (onclickValue.includes(selectedDate)) {
                        cell.classList.add('selected-date', 'bg-yellow-200', 'border-2', 'border-yellow-400');
                    }
                }
            });
        }
    </script>
</body>
</html>