<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>予約システム</title>
    
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Tailwind CSS の CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Flatpickr CSS and JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
    <script>
      document.addEventListener("dblclick", function(e){ e.preventDefault();}, { passive: false });
    </script>
    <style>
      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      /* プルダウン選択メニューのスタイル調整 */
      select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        padding-right: 2.5rem;
      }

      /* ブラウザ固有のスタイル調整 */
      select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        padding-right: 2.5rem;
      }

      /* Firefox用の追加調整 */
      @supports (-moz-appearance: none) {
        select {
          text-indent: 0.01px;
          text-overflow: '';
        }
      }

      /* Safari用の追加調整 */
      @supports (-webkit-appearance: none) {
        select {
          border-radius: 5px;
        }
      }
      
      /* カスタムスタイル */
      .day-cell {
        position: relative;
      }
      .status-marker {
        text-align: center;
        border-radius: 50%;
      }
      
      /* ドロップダウン用カスタムスタイル */
      .custom-dropdown {
        position: relative;
      }
      
      .dropdown-option {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      
      .dropdown-option:hover {
        background-color: #f0f9ff;
      }
      
      .dropdown-option.selected {
        background-color: #0891b2;
        color: white;
      }
      
      .dropdown-option-image {
        width: 32px;
        height: 32px;
        object-fit: cover;
        border-radius: 4px;
        margin-right: 12px;
        flex-shrink: 0;
      }
      
      .dropdown-options {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #d1d5db;
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 50;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        display: none;
      }
      
      .dropdown-options.show {
        display: block;
      }
      
      /* モーダルスタイル */
      .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(3px);
        animation: fadeIn 0.3s ease-out;
      }
      
      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 90vw;
        max-height: 90vh;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        animation: scaleIn 0.3s ease-out;
      }
      
      .modal-image {
        width: 100%;
        height: auto;
        max-height: 80vh;
        object-fit: contain;
        display: block;
      }
      
      .modal-caption {
        padding: 16px 20px;
        background: white;
        font-size: 16px;
        font-weight: 500;
        color: #374151;
        text-align: center;
        border-top: 1px solid #e5e7eb;
      }
      
      .modal-close {
        position: absolute;
        top: 10px;
        right: 15px;
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        z-index: 10000;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
      }
      
      .modal-close:hover {
        background: rgba(0, 0, 0, 0.7);
      }
      
      @keyframes scaleIn {
        from { transform: translate(-50%, -50%) scale(0.7); opacity: 0; }
        to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      }
      
      /* 画像をクリック可能であることを示すカーソル */
      .clickable-image {
        cursor: pointer;
        transition: opacity 0.2s;
      }
      
      .clickable-image:hover {
        opacity: 0.8;
      }
    </style>
</head>
<body class="bg-zinc-100 text-zinc-600">
    <!-- アプリ本体 -->
    <div id="app" class="container mx-auto px-4 py-8 max-w-5xl">
        <div class="flex justify-between items-center mb-4 md:mb-8">
            <h1 class="text-xl md:text-3xl sm:text-2xl font-bold">予約システム</h1>
            <div class="flex gap-2">
                <a href="/reservations/" class="inline-flex items-center gap-1 px-3 py-2 text-sm font-medium text-white bg-cyan-500 hover:bg-cyan-600 rounded-lg transition-colors whitespace-nowrap shadow-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                    </svg>
                    予約状況確認
                </a>
                <a href="/admin/" class="text-sm text-cyan-600 hover:underline px-3 py-2">管理画面</a>
            </div>
        </div>
        
        <!-- カレンダー部分 -->
        <div class="bg-white rounded-lg shadow-[0_0_5px_0_rgba(0,0,0,0.05)] py-6 px-4 md:py-6 md:px-6 mb-6">
            
            <!-- 表示切り替えプルダウン -->
            <div class="max-w-full overflow-hidden mb-6 pb-6 border-b">
                <div class="flex flex-col justify-between md:flex-row items-center sm:items-left mb-4">
                    <label for="calendar-item" class="font-semibold mb-3 md:mb-0 md:mr-2 text-base sm:text-base">カレンダー表示を選択</label>
                    <select id="calendar-item" class="w-full md:w-[425px] border rounded p-2 sm:p-3 text-sm sm:text-sm md:text-base focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-inset bg-white h-12 md:h-auto">
                        <option value="">すべての物品の空き状況</option>
                        {% for item in items %}
                            <option value="{{ item.id }}"
                                    data-dropdown-image="{% if item.get_primary_image %}{{ item.get_primary_image.get_dropdown_thumbnail_url }}{% endif %}"
                                    data-dropdown-alt="{% if item.get_primary_image %}{{ item.get_primary_image.alt_text|default:item.name }}{% endif %}">
                                {{ item.name }}のみ表示
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- 選択された物品の画像表示エリア -->
                <div id="selected-item-image" class="hidden">
                    <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg border">
                        <div class="flex-shrink-0">
                            <img id="item-image" src="" alt="" class="w-20 h-20 object-cover rounded-md shadow-sm clickable-image" onclick="openImageModal(this)">
                        </div>
                        <div id="item-info">
                            <p class="font-medium text-base text-gray-900" id="item-name"></p>
                            <p class="text-sm text-gray-600">選択された物品</p>
                            <p class="text-xs text-gray-500 mt-1">※ 実際の商品と色合いが異なる場合があります</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- カレンダー表示エリア -->
            <div id="calendar-container">
                <!-- 月表示とナビゲーションボタン -->
                <div class="flex flex-col justify-between items-center mb-3">
                    <div class="flex w-full justify-between items-center mb-2 sm:mb-3">
                        <button id="prev-month" class="bg-cyan-500 hover:bg-cyan-600 text-white py-4 px-4 sm:py-3 sm:px-4 md:py-2 md:px-4 text-xs sm:text-sm md:text-base rounded mr-2 sm:mr-3 md:mr-4 transition">前月</button>
                        <h3 id="current-month" class="text-base sm:text-lg md:text-xl font-semibold">2025年8月</h3>
                        <button id="next-month" class="bg-cyan-500 hover:bg-cyan-600 text-white py-4 px-4 sm:py-3 sm:px-4 md:py-2 md:px-4 text-xs sm:text-sm md:text-base rounded ml-2 sm:ml-3 md:ml-4 transition">翌月</button>
                    </div>
                </div>
                
                <!-- 凡例 -->
                <div class="flex justify-center gap-2 sm:gap-3 md:gap-4 mb-3 sm:mb-4 md:mb-5 flex-wrap">
                    <div class="flex items-center">
                        <div class="mr-1 sm:mr-2 text-cyan-600 text-sm sm:text-base">◯</div>
                        <span class="text-xs sm:text-sm md:text-base">予約可能</span>
                    </div>
                    <div class="flex items-center">
                        <div class="mr-1 sm:mr-2 text-orange-500 text-sm sm:text-base">△</div>
                        <span class="text-xs sm:text-sm md:text-base">残りわずか</span>
                    </div>
                    <div class="flex items-center">
                        <div class="mr-1 sm:mr-2 text-red-600 text-sm sm:text-base">✕</div>
                        <span class="text-xs sm:text-sm md:text-base">予約不可</span>
                    </div>
                    <div class="flex items-center">
                        <div class="mr-1 sm:mr-2 text-gray-600 text-sm sm:text-base">休</div>
                        <span class="text-xs sm:text-sm md:text-base">休業日</span>
                    </div>
                </div>
                
                <div id="calendar-content">
                    <!-- カレンダーがここに動的に表示される -->
                </div>
                
                <p class="text-sm text-gray-600 text-center mt-4">※ ◯をクリックすると下のフォームに自動入力されます</p>
            </div>
            
        </div>
        
        <!-- 予約フォーム部分 -->
        <div id="reservation-form-section" class="bg-white rounded-lg shadow-[0_0_5px_0_rgba(0,0,0,0.05)] py-6 px-4 md:py-6 md:px-6">
            <h2 class="text-xl sm:text-2xl font-bold text-center text-cyan-500 mb-4 sm:mb-5 md:mb-6">予約フォーム</h2>
            {% if errors %}
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                    <ul class="list-disc list-inside">
                        {% for error in errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            
            <form method="post" class="space-y-5 sm:space-y-6">
                {% csrf_token %}
                <div>
                    <label for="item" class="block font-semibold mb-2 text-sm md:text-base">レンタル物品 *</label>
                    <select id="item" name="item" required class="w-full p-2 sm:p-3 text-sm md:text-base border rounded focus:outline-none focus:ring-2 focus:ring-cyan-500 bg-white h-12 md:h-auto">
                        <option value="">選択してください</option>
                        {% for item in items %}
                            <option value="{{ item.id }}" 
                                    data-image-url="{% if item.get_primary_image %}{{ item.get_primary_image.get_thumbnail_url|default:item.get_primary_image.image.url }}{% endif %}"
                                    data-image-alt="{% if item.get_primary_image %}{{ item.get_primary_image.alt_text|default:item.name }}{% endif %}"
                                    {% if form_data.item == item.id|stringformat:"s" %}selected{% endif %}>
                                {{ item.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="date" class="block font-semibold mb-2 text-sm md:text-base">予約日 *</label>
                    <input type="date" id="date" name="date" value="{{ form_data.date|default:'' }}" required class="w-full p-2 sm:p-3 text-sm md:text-base border rounded focus:outline-none focus:ring-2 focus:ring-cyan-500 bg-white h-12 md:h-auto">
                </div>
                
                <div>
                    <label for="name" class="block font-semibold mb-2 text-sm md:text-base">名前 *</label>
                    <input type="text" id="name" name="name" value="{{ form_data.name|default:'' }}" required class="w-full p-2 sm:p-3 text-sm md:text-base border rounded focus:outline-none focus:ring-2 focus:ring-cyan-500 h-12 md:h-auto" placeholder="予約者名">
                </div>
                
                <div>
                    <label for="phone" class="block font-semibold mb-2 text-sm md:text-base">電話番号 *</label>
                    <input type="tel" id="phone" name="phone" value="{{ form_data.phone|default:'' }}" required class="w-full p-2 sm:p-3 text-sm md:text-base border rounded focus:outline-none focus:ring-2 focus:ring-cyan-500 h-12 md:h-auto" placeholder="090-1234-5678">
                </div>
                
                <div>
                    <label for="email" class="block font-semibold mb-2 text-sm md:text-base">メールアドレス *</label>
                    <input type="email" id="email" name="email" value="{{ form_data.email|default:'' }}" required class="w-full p-2 sm:p-3 text-sm md:text-base border rounded focus:outline-none focus:ring-2 focus:ring-cyan-500 h-12 md:h-auto" placeholder="example@email.com">
                </div>
                
                <div>
                    <label for="notes" class="block font-semibold mb-2 text-sm md:text-base">備考</label>
                    <textarea id="notes" name="notes" class="w-full p-2 sm:p-3 text-sm md:text-base border rounded focus:outline-none focus:ring-2 focus:ring-cyan-500" rows="3" placeholder="特記事項があれば記入してください">{{ form_data.notes|default:'' }}</textarea>
                </div>
                
                <button type="submit" class="block w-full md:max-w-xs mx-auto bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-4 sm:py-3 md:py-4 px-3 sm:px-4 md:px-10 text-sm md:text-base rounded transition mt-4 sm:mt-5 md:mt-6">予約する</button>
                
                <div id="message" class="mt-4 text-center hidden text-sm md:text-base"></div>
            </form>
        </div>
    </div>

    <!-- 画像モーダル -->
    <div id="imageModal" class="modal">
        <span class="modal-close" onclick="closeImageModal()">&times;</span>
        <div class="modal-content">
            <img id="modalImage" class="modal-image" src="" alt="">
            <div id="modalCaption" class="modal-caption"></div>
        </div>
    </div>

    <script>
        // 画像モーダル機能
        function openImageModal(imgElement) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const caption = document.getElementById('modalCaption');
            
            // data-large-url属性から大きな画像のURLを取得、なければ元のsrcを使用
            const largeImageSrc = imgElement.getAttribute('data-large-url') || imgElement.src;
            
            console.log('Opening modal with image:', largeImageSrc); // デバッグ用
            
            modalImg.src = largeImageSrc;
            modalImg.alt = imgElement.alt;
            caption.innerHTML = imgElement.alt || '画像詳細';
            
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // スクロールを無効化
        }
        
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto'; // スクロールを有効化
        }
        
        // モーダル外をクリックしたときに閉じる
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                closeImageModal();
            }
        });
        
        // ESCキーでモーダルを閉じる
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImageModal();
            }
        });
        
        // flatpickrの初期化
        let datePicker = null;
        
        function initializeDatePicker(disabledDates = []) {
            // 現在選択されている日付を保存
            const currentSelectedDate = document.getElementById('date').value;
            
            if (datePicker) {
                datePicker.destroy();
            }
            
            const today = new Date();
            const minDate = new Date();
            minDate.setDate(today.getDate() + 5); // 5日後から予約可能
            const oneYearLater = new Date();
            oneYearLater.setFullYear(today.getFullYear() + 1);
            
            // デフォルト日付を決定（現在選択されている日付があればそれを使用、なければminDate）
            const defaultDate = currentSelectedDate || minDate;
            
            datePicker = flatpickr("#date", {
                locale: "ja",
                dateFormat: "Y-m-d",
                minDate: minDate,
                maxDate: oneYearLater,
                defaultDate: defaultDate,
                disable: disabledDates,
                onChange: function(selectedDates, dateStr, instance) {
                    // 日付が選択されたときの処理
                }
            });
        }
        
        // 初期化（物品未選択時は空の無効日付配列）
        initializeDatePicker();
        
        // CSRF トークンを取得する関数
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        
        // カレンダー物品選択の変更イベント
        document.getElementById('calendar-item').addEventListener('change', function() {
            const itemId = this.value;
            const selectedOption = this.options[this.selectedIndex];
            
            if (itemId === '') {
                // 「すべて表示」の場合はマージされたカレンダーを表示し、画像を隠す
                loadMergedCalendar();
                hideItemImage();
            } else {
                // 特定の物品が選択された場合は個別カレンダーを表示し、画像を表示
                loadCalendar(itemId);
                showItemImageForCalendar(selectedOption);
            }
        });
        
        // 簡素化されたドロップダウンエンハンス
        function enhanceDropdown() {
            const select = document.getElementById('calendar-item');
            const options = select.querySelectorAll('option[value!=""]');
            
            console.log('Enhancing dropdown with', options.length, 'options');
            
            // オプションに画像データを確認
            options.forEach(option => {
                const imageUrl = option.dataset.dropdownImage;
                console.log('Option:', option.textContent, 'has image:', !!imageUrl, 'URL:', imageUrl);
            });
            
            // 簡単なツールチップ表示を追加
            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const imageUrl = selectedOption.dataset.dropdownImage;
                
                if (imageUrl) {
                    console.log('Selected item has image:', imageUrl);
                    showImagePreview(imageUrl, selectedOption.textContent);
                }
            });
        }
        
        function showImagePreview(imageUrl, itemName) {
            // 既存のプレビューを削除
            const existingPreview = document.getElementById('dropdown-preview');
            if (existingPreview) {
                existingPreview.remove();
            }
            
            // 新しいプレビューを作成
            const preview = document.createElement('div');
            preview.id = 'dropdown-preview';
            preview.className = 'mt-2 p-2 bg-blue-50 rounded flex items-center gap-3';
            preview.innerHTML = `
                <img src="${imageUrl}" alt="${itemName}" class="w-12 h-12 object-cover rounded">
                <span class="text-sm font-medium">${itemName}を選択中</span>
            `;
            
            const selectContainer = document.getElementById('calendar-item').parentElement;
            selectContainer.appendChild(preview);
        }
        
        // カレンダー選択時の画像表示関数
        function showItemImageForCalendar(selectedOption) {
            const imageContainer = document.getElementById('selected-item-image');
            const itemImage = document.getElementById('item-image');
            const itemName = document.getElementById('item-name');
            
            const imageUrl = selectedOption.dataset.dropdownImage;
            const imageAlt = selectedOption.dataset.dropdownAlt;
            
            if (imageUrl) {
                itemImage.src = imageUrl;
                itemImage.alt = imageAlt || selectedOption.textContent;
                // 大きな画像のURLをdata属性に保存（ドロップダウンサイズから元のサイズへ変換）
                const largeImageUrl = imageUrl.replace('/dropdown/', '/').replace('_dropdown', '');
                itemImage.setAttribute('data-large-url', largeImageUrl);
                itemName.textContent = selectedOption.textContent;
                imageContainer.classList.remove('hidden');
                imageContainer.classList.add('fade-in');
            } else {
                hideItemImage();
            }
        }
        
        // 画像を隠す関数
        function hideItemImage() {
            const imageContainer = document.getElementById('selected-item-image');
            imageContainer.classList.add('hidden');
            imageContainer.classList.remove('fade-in');
        }
        

        // フォームの物品選択変更イベント（flatpickr更新用・画像表示用）
        document.getElementById('item').addEventListener('change', function() {
            const itemId = this.value;
            const selectedOption = this.options[this.selectedIndex];
            
            // 画像表示の更新
            updateItemImageDisplay(selectedOption);
            
            if (itemId === '') {
                // 物品未選択の場合は無効日付なし
                initializeDatePicker([]);
            } else {
                // 選択された物品の無効日付を取得してflatpickrを更新
                updateDatePickerDisabledDates(itemId);
            }
        });
        
        // 物品画像表示を更新する関数
        function updateItemImageDisplay(selectedOption) {
            const imageContainer = document.getElementById('selected-item-image');
            const itemImage = document.getElementById('item-image');
            const itemName = document.getElementById('item-name');
            
            if (selectedOption.value && selectedOption.dataset.imageUrl) {
                // 画像がある場合
                itemImage.src = selectedOption.dataset.imageUrl;
                itemImage.alt = selectedOption.dataset.imageAlt || selectedOption.text;
                // 大きな画像のURLをdata属性に保存（フォームの場合は既に大きなサイズ）
                itemImage.setAttribute('data-large-url', selectedOption.dataset.imageUrl);
                itemName.textContent = selectedOption.text;
                imageContainer.classList.remove('hidden');
                imageContainer.classList.add('fade-in');
            } else {
                // 画像がない場合は非表示
                imageContainer.classList.add('hidden');
                imageContainer.classList.remove('fade-in');
            }
        }
        
        // 予約不可日付を取得してflatpickrを更新する関数
        function updateDatePickerDisabledDates(itemId) {
            return fetch(`/disabled-dates/${itemId}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 無効日付でflatpickrを再初期化
                    initializeDatePicker(data.disabled_dates);
                    return data.disabled_dates;
                } else {
                    console.error('Failed to get disabled dates:', data.error);
                    // エラーの場合は無効日付なしで初期化
                    initializeDatePicker([]);
                    return [];
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // エラーの場合は無効日付なしで初期化
                initializeDatePicker([]);
                return [];
            });
        }
        
        // 現在の表示月を管理（予約可能日からの月を設定）
        const minReservationDate = new Date();
        minReservationDate.setDate(minReservationDate.getDate() + 5);
        let currentYear = minReservationDate.getFullYear();
        let currentMonth = minReservationDate.getMonth() + 1;
        let currentItemId = null;
        
        // マージされたカレンダーデータを読み込む関数
        function loadMergedCalendar(year = null, month = null) {
            const calendarContent = document.getElementById('calendar-content');
            calendarContent.innerHTML = '<div class="text-center py-4">読み込み中...</div>';
            
            currentItemId = null; // マージ表示時はnull
            if (year !== null) currentYear = year;
            if (month !== null) currentMonth = month;
            
            fetch(`/merged-calendar-data/?year=${currentYear}&month=${currentMonth}`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayCalendar(data.calendar_data);
                } else {
                    calendarContent.innerHTML = '<div class="text-center py-4 text-red-500">カレンダーの読み込みに失敗しました</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                calendarContent.innerHTML = '<div class="text-center py-4 text-red-500">エラーが発生しました</div>';
            });
        }
        
        // 個別物品のカレンダーデータを読み込む関数
        function loadCalendar(itemId, year = null, month = null) {
            const calendarContent = document.getElementById('calendar-content');
            calendarContent.innerHTML = '<div class="text-center py-4">読み込み中...</div>';
            
            // 現在のアイテムIDと月を保存
            currentItemId = itemId;
            if (year !== null) currentYear = year;
            if (month !== null) currentMonth = month;
            
            fetch(`/calendar-data/${itemId}/?year=${currentYear}&month=${currentMonth}`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayCalendar(data.calendar_data);
                } else {
                    calendarContent.innerHTML = '<div class="text-center py-4 text-red-500">カレンダーの読み込みに失敗しました</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                calendarContent.innerHTML = '<div class="text-center py-4 text-red-500">エラーが発生しました</div>';
            });
        }
        
        // カレンダーを表示する関数
        function displayCalendar(calendarData) {
            const calendarContent = document.getElementById('calendar-content');
            
            // 月表示を更新
            document.getElementById('current-month').textContent = calendarData.month_name;
            
            let html = '<div class="overflow-x-auto">';
            html += '<table class="w-full border-collapse">';
            
            // ヘッダー（曜日）- _publicスタイルに合わせる
            html += '<thead>';
            html += '<tr class="border-r">';
            html += '<th class="border-l border-t border-b p-1 sm:p-2 bg-gray-50 font-normal text-red-700 text-xs sm:text-sm md:text-base">日</th>';
            html += '<th class="border-l border-t border-b p-1 sm:p-2 bg-gray-50 font-normal text-xs sm:text-sm md:text-base">月</th>';
            html += '<th class="border-l border-t border-b p-1 sm:p-2 bg-gray-50 font-normal text-xs sm:text-sm md:text-base">火</th>';
            html += '<th class="border-l border-t border-b p-1 sm:p-2 bg-gray-50 font-normal text-xs sm:text-sm md:text-base">水</th>';
            html += '<th class="border-l border-t border-b p-1 sm:p-2 bg-gray-50 font-normal text-xs sm:text-sm md:text-base">木</th>';
            html += '<th class="border-l border-t border-b p-1 sm:p-2 bg-gray-50 font-normal text-xs sm:text-sm md:text-base">金</th>';
            html += '<th class="border-l border-t border-b p-1 sm:p-2 bg-gray-50 font-normal text-cyan-700 text-xs sm:text-sm md:text-base">土</th>';
            html += '</tr>';
            html += '</thead>';
            
            // カレンダーボディ（実際のデータ）- _publicスタイルに合わせる
            html += '<tbody id="calendar-body" class="border-r border-b border-l">';
            calendarData.weeks.forEach(week => {
                html += '<tr>';
                week.forEach((day, index) => {
                    // 当月以外または過去の日付は薄いグレー
                    const isInactive = !day.is_current_month || day.is_past_date;
                    
                    // ステータスに基づく色設定
                    let statusColor = 'text-gray-300';
                    if (!isInactive) {
                        if (day.status_text === '◯') {
                            statusColor = 'text-cyan-600';
                        } else if (day.status_text === '△') {
                            statusColor = 'text-orange-500';
                        } else if (day.status_text === '✕') {
                            statusColor = 'text-red-600';
                        } else if (day.status_text === '休') {
                            statusColor = 'text-gray-600';
                        }
                    }
                    
                    // クリック可否判定：◯と△はクリック可能、✕と休はクリック不可
                    const isClickable = !isInactive && (day.status_text === '◯' || day.status_text === '△');
                    
                    const hoverClass = isClickable ? 'hover:bg-cyan-50' : '';
                    const clickable = isClickable ? `onclick="selectDate('${day.date}')"` : '';
                    const cursor = isClickable ? 'cursor-pointer' : 'cursor-not-allowed';
                    
                    
                    // 日付の色（日曜日：赤、土曜日：青、その他：グレー、ただし当月以外は薄く）
                    let dayColor = 'text-gray-700';
                    if (isInactive) {
                        dayColor = 'text-gray-300';
                    } else if (index === 0) {
                        dayColor = 'text-red-700';
                    } else if (index === 6) {
                        dayColor = 'text-cyan-700';
                    }
                    
                    html += `<td class="day-cell border-l border-t p-1 sm:p-2 text-center min-h-[60px] sm:min-h-[70px] md:min-h-[80px] ${hoverClass} ${cursor}" ${clickable}>
                        <div class="text-xs sm:text-sm md:text-base mb-1 ${dayColor}">${day.day}</div>
                        <div class="status-marker text-sm sm:text-base md:text-lg ${statusColor} transition-colors">
                            ${day.status_text}
                        </div>
                    </td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            
            calendarContent.innerHTML = html;
            
            // 前月・翌月ボタンのイベントリスナーを設定
            setupMonthNavigation();
        }
        
        // 前月・翌月ナビゲーションの設定
        function setupMonthNavigation() {
            document.getElementById('prev-month').onclick = function() {
                let prevMonth = currentMonth - 1;
                let prevYear = currentYear;
                if (prevMonth < 1) {
                    prevMonth = 12;
                    prevYear--;
                }
                
                // 現在の表示モードに応じてカレンダーを読み込む
                if (currentItemId === null) {
                    loadMergedCalendar(prevYear, prevMonth);
                } else {
                    loadCalendar(currentItemId, prevYear, prevMonth);
                }
            };
            
            document.getElementById('next-month').onclick = function() {
                let nextMonth = currentMonth + 1;
                let nextYear = currentYear;
                if (nextMonth > 12) {
                    nextMonth = 1;
                    nextYear++;
                }
                
                // 現在の表示モードに応じてカレンダーを読み込む
                if (currentItemId === null) {
                    loadMergedCalendar(nextYear, nextMonth);
                } else {
                    loadCalendar(currentItemId, nextYear, nextMonth);
                }
            };
        }
        
        // カレンダーの日付選択関数
        function selectDate(dateStr) {
            if (currentItemId === null) {
                // マージ表示時：選択された日付に予約可能な物品を取得
                fetch(`/available-items/?date=${dateStr}`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 物品選択肢を更新
                        updateItemOptions(data.available_items);
                        
                        // 日付フィールドを確実に設定（flatpickrを先に更新）
                        if (datePicker) {
                            datePicker.setDate(dateStr, true); // trueにして変更イベントも発火
                        }
                        // HTMLフィールドも確実に設定
                        document.getElementById('date').value = dateStr;
                        
                        // 選択された日付をハイライト表示
                        highlightSelectedDate(dateStr);
                        
                        // 予約フォームにスムーズスクロール
                        scrollToForm();
                    } else {
                        alert('選択された日付の物品情報の取得に失敗しました。');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('エラーが発生しました。');
                });
            } else {
                // 個別物品表示時：選択された物品をフォームに設定
                const itemSelect = document.getElementById('calendar-item');
                const itemName = itemSelect.options[itemSelect.selectedIndex].text;
                
                // フォームの物品選択を更新
                document.getElementById('item').value = currentItemId;
                
                // 日付フィールドを確実に設定してからflatpickrを更新
                updateDatePickerDisabledDates(currentItemId).then(() => {
                    // flatpickrで日付を設定
                    if (datePicker) {
                        datePicker.setDate(dateStr, true); // trueにして変更イベントも発火
                    }
                    // HTMLフィールドも確実に設定
                    document.getElementById('date').value = dateStr;
                });
                
                // 選択された日付をハイライト表示
                highlightSelectedDate(dateStr);
                
                // 予約フォームにスムーズスクロール
                scrollToForm();
            }
        }
        
        // フォームへのスムーズスクロール
        function scrollToForm() {
            const formSection = document.getElementById('reservation-form-section');
            if (formSection) {
                formSection.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }
        
        // 物品選択肢を更新する関数
        function updateItemOptions(availableItems) {
            const itemSelect = document.getElementById('item');
            itemSelect.innerHTML = '<option value="">選択してください</option>';
            
            availableItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.name;
                itemSelect.appendChild(option);
            });
        }
        
        // フォーム送信前のバリデーション
        document.querySelector('form').addEventListener('submit', function(e) {
            const selectedDate = document.getElementById('date').value;
            const selectedItemId = document.getElementById('item').value;
            
            if (selectedDate && selectedItemId) {
                // 選択された日付が予約可能かチェック
                fetch(`/check-availability/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({
                        date: selectedDate,
                        item_id: selectedItemId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.available) {
                        e.preventDefault();
                        alert('申し訳ございませんが、選択された日付は既に予約済みまたは利用不可です。他の日付をお選びください。');
                        return false;
                    }
                })
                .catch(error => {
                    console.error('Availability check error:', error);
                });
            }
        });
        
        // 選択した日付をハイライト表示する関数
        function highlightSelectedDate(selectedDate) {
            // 以前のハイライトを削除
            const previousHighlighted = document.querySelectorAll('.selected-date');
            previousHighlighted.forEach(element => {
                element.classList.remove('selected-date', 'bg-yellow-200', 'border-2', 'border-yellow-400');
            });
            
            // 新しい日付をハイライト
            const allCells = document.querySelectorAll('.day-cell');
            allCells.forEach(cell => {
                const statusMarker = cell.querySelector('.status-marker');
                if (statusMarker && statusMarker.getAttribute('onclick')) {
                    const onclickValue = statusMarker.getAttribute('onclick');
                    if (onclickValue.includes(selectedDate)) {
                        cell.classList.add('selected-date', 'bg-yellow-200', 'border-2', 'border-yellow-400');
                    }
                }
            });
        }
        
        // ページ読み込み時に初期カレンダーを表示・画像初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadMergedCalendar();
            enhanceDropdown();
            
            // 既に物品が選択されている場合の画像表示初期化
            const itemSelect = document.getElementById('item');
            if (itemSelect.value) {
                const selectedOption = itemSelect.options[itemSelect.selectedIndex];
                updateItemImageDisplay(selectedOption);
            }
        });
    </script>
</body>
</html>